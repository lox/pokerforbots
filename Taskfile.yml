version: '3'

tasks:
  default:
    desc: List available tasks
    cmds:
      - task --list

  generate:
    desc: Generate all code (protocol and preflop tables)
    deps:
      - generate:protocol
      - generate:preflop

  generate:protocol:
    desc: Generate msgpack protocol code
    cmds:
      - go generate ./protocol
    sources:
      - protocol/messages.go
    generates:
      - protocol/messages_gen.go

  generate:preflop:
    desc: Generate preflop equity tables
    cmds:
      - go generate ./sdk/analysis
    sources:
      - sdk/analysis/preflop.go
      - cmd/gen-preflop/main.go
    generates:
      - sdk/analysis/preflop_gen.go

  build:
    desc: Build all binaries
    cmds:
      - mkdir -p dist
      - go build -o dist/server ./cmd/server
      - go build -o dist/client ./cmd/client
      - go build -o dist/spawner ./cmd/spawner
      - go build -o dist/complex-bot ./sdk/examples/complex
    sources:
      - '**/*.go'
    generates:
      - dist/server
      - dist/client
      - dist/spawner
      - dist/complex-bot

  snapshot:
    desc: Create a new snapshot of the complex bot
    cmds:
      - mkdir -p snapshots
      - |
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "uncommitted")
        DATE=$(date +%Y%m%d)
        OUTPUT="snapshots/complex-${DATE}-${COMMIT}"
        echo "Building snapshot: ${OUTPUT}"
        go build -o "${OUTPUT}" ./sdk/examples/complex
        chmod +x "${OUTPUT}"

        # Update symlinks
        cd snapshots
        ln -sf $(basename "${OUTPUT}") complex-latest

        echo "Snapshot created:"
        ls -la complex-*

  server:
    desc: Run the poker server
    cmds:
      - go run ./cmd/server {{.CLI_ARGS}}

  client:
    desc: Run the poker client
    cmds:
      - go run ./cmd/client {{.CLI_ARGS}}

  test:
    desc: Run all tests with race detector
    cmds:
      - bin/gotestsum -f pkgname-and-test-fails --format-icons hivis -- -race -parallel 12 ./...

  test:slowest:
    desc: Report slowest tests (short mode)
    cmds:
      - go test -json -short ./... | gotestsum tool slowest

  lint:
    desc: Run linters
    cmds:
      - bin/golangci-lint run ./...
      - bin/go run golang.org/x/tools/gopls/internal/analysis/modernize/cmd/modernize@latest -test ./...
      - bin/go run golang.org/x/tools/gopls/internal/analysis/unusedparams/cmd@latest -test ./...

  format:
    desc: Format code
    cmds:
      - bin/golangci-lint fmt ./...

  lint:fix:
    desc: Run linters with fix
    cmds:
      - bin/golangci-lint run --fix ./...
      - bin/go run golang.org/x/tools/gopls/internal/analysis/modernize/cmd/modernize@latest -test -fix ./...
      - bin/go run golang.org/x/tools/gopls/internal/analysis/unusedparams/cmd@latest -test -fix ./...

  bench:
    desc: Run performance benchmark using spawner
    cmds:
      - go run ./cmd/spawner --demo=simple --num-bots=6 --hand-limit=1000 {{.CLI_ARGS}}
    silent: false

  bench:go:
    desc: Run Go test benchmarks
    cmds:
      - go test -bench=. -benchmem {{if .CLI_ARGS}}{{.CLI_ARGS}}{{else}}-benchtime=100ms{{end}} ./...

  regression:
    desc: Run regression tests between bot versions
    cmds:
      - go run ./cmd/regression-tester {{.CLI_ARGS}}

  regression:heads-up:
    desc: Run heads-up regression test
    cmds:
      - |
        go run ./cmd/regression-tester --mode heads-up \
          --challenger "{{.CHALLENGER | default "./snapshots/complex-latest"}}" \
          --baseline "{{.BASELINE | default "go run ./sdk/examples/complex"}}" \
          --hands {{.HANDS | default "50000"}} \
          --output {{.OUTPUT | default "summary"}}

  regression:population:
    desc: Run population regression test
    cmds:
      - |
        go run ./cmd/regression-tester --mode population \
          --challenger "{{.CHALLENGER | default "./snapshots/complex-latest"}}" \
          --baseline "{{.BASELINE | default "go run ./sdk/examples/complex"}}" \
          --hands {{.HANDS | default "50000"}} \
          --output {{.OUTPUT | default "summary"}}

  regression:npc:
    desc: Run NPC benchmark regression test
    cmds:
      - |
        go run ./cmd/regression-tester --mode npc-benchmark \
          --challenger "{{.CHALLENGER | default "./snapshots/complex-latest"}}" \
          --baseline "{{.BASELINE | default "go run ./sdk/examples/complex"}}" \
          --hands {{.HANDS | default "50000"}} \
          --output {{.OUTPUT | default "summary"}}

  regression:self-play:
    desc: Run self-play regression test
    cmds:
      - |
        go run ./cmd/regression-tester --mode self-play \
          --challenger "{{.CHALLENGER | default "./snapshots/complex-latest"}}" \
          --baseline "{{.BASELINE | default "go run ./sdk/examples/complex"}}" \
          --hands {{.HANDS | default "50000"}} \
          --output {{.OUTPUT | default "summary"}}

  regression:all:
    desc: Run all regression test modes sequentially
    cmds:
      - task: regression:heads-up
        vars:
          CHALLENGER: "{{.CHALLENGER}}"
          BASELINE: "{{.BASELINE}}"
          HANDS: "{{.HANDS}}"
          OUTPUT: "{{.OUTPUT}}"
      - task: regression:population
        vars:
          CHALLENGER: "{{.CHALLENGER}}"
          BASELINE: "{{.BASELINE}}"
          HANDS: "{{.HANDS}}"
          OUTPUT: "{{.OUTPUT}}"
      - task: regression:npc
        vars:
          CHALLENGER: "{{.CHALLENGER}}"
          BASELINE: "{{.BASELINE}}"
          HANDS: "{{.HANDS}}"
          OUTPUT: "{{.OUTPUT}}"
      - task: regression:self-play
        vars:
          CHALLENGER: "{{.CHALLENGER}}"
          BASELINE: "{{.BASELINE}}"
          HANDS: "{{.HANDS}}"
          OUTPUT: "{{.OUTPUT}}"

  bench:evaluator:
    desc: Run evaluator large-sample benchmarks (sequential and parallel)
    cmds:
      - go test -run ^$ -bench BenchmarkEvaluate7Cards_LargeSample$ -benchmem ./poker {{.CLI_ARGS}}
      - go test -run ^$ -bench BenchmarkEvaluate7Cards_LargeSample_Parallel$ -benchmem ./poker {{.CLI_ARGS}}

  profile:evaluator:top:
    desc: Quick top-10 CPU for non-parallel evaluator benchmark (pprof)
    cmds:
      - mkdir -p dist
      - go test -c -o dist/evaluator.test ./poker
      - ./dist/evaluator.test -test.run=^$ -test.bench=^BenchmarkEvaluate7Cards_LargeSample$ -test.count=1 -test.benchtime=10s -test.cpuprofile=dist/eval-seq.pprof {{.CLI_ARGS}}
      - go tool pprof -top -nodecount=10 ./dist/evaluator.test dist/eval-seq.pprof

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf dist/
      - rm -f protocol/*_gen.go
      - rm -f protocol/*_gen_test.go
